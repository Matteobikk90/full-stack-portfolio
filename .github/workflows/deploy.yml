name: Deploy to EC2 via Registry

on:
  push:
    branches: [main, dev]

concurrency:
  group: deploy-ec2
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîß Set Docker metadata
        run: |
          echo "IMAGE_TAG=${GITHUB_SHA}" >> "$GITHUB_ENV"
          echo "USERNAME=${GITHUB_REPOSITORY%%/*}" >> "$GITHUB_ENV"
          echo "REGISTRY=ghcr.io/${USERNAME,,}" >> "$GITHUB_ENV"

      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üê≥ Build client image
        run: |
          docker build -t $REGISTRY/client:$IMAGE_TAG -f apps/client/Dockerfile apps/client
          docker tag $REGISTRY/client:$IMAGE_TAG $REGISTRY/client:latest

      - name: üê≥ Build server image
        run: |
          SERVER_SUFFIX=$( [ "${{ github.ref_name }}" = "main" ] && echo "prod" || echo "dev" )
          docker build -t $REGISTRY/server-$SERVER_SUFFIX:$IMAGE_TAG -f apps/server/Dockerfile apps/server
          docker tag $REGISTRY/server-$SERVER_SUFFIX:$IMAGE_TAG $REGISTRY/server-$SERVER_SUFFIX:latest

      - name: üì§ Push images to registry
        run: |
          docker push $REGISTRY/client:$IMAGE_TAG
          docker push $REGISTRY/client:latest

          SERVER_SUFFIX=$( [ "${{ github.ref_name }}" = "main" ] && echo "prod" || echo "dev" )
          docker push $REGISTRY/server-$SERVER_SUFFIX:$IMAGE_TAG
          docker push $REGISTRY/server-$SERVER_SUFFIX:latest

      - name: üöÄ Deploy on EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            set -e
            REGISTRY=ghcr.io/${GITHUB_REPOSITORY%%/*}
            TAG=${GITHUB_SHA}

            if [ "${GITHUB_REF_NAME}" = "main" ]; then
              SERVICE_NAME="server-prod"
            else
              SERVICE_NAME="server-dev"
            fi

            echo "üì• Pulling images from GHCR..."
            docker pull $REGISTRY/client:$TAG
            docker pull $REGISTRY/$SERVICE_NAME:$TAG

            docker tag $REGISTRY/client:$TAG portfolio/client:$TAG
            docker tag $REGISTRY/$SERVICE_NAME:$TAG portfolio/$SERVICE_NAME:$TAG

            echo "üöÄ Starting containers..."
            docker compose -f ~/full-stack-portfolio/docker-compose.yml up -d $SERVICE_NAME client

            echo "üßπ Cleaning unused Docker resources..."
            docker container prune -f
            docker image prune -af
            docker volume prune -f
            docker system prune -af --volumes
